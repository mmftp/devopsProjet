FROM node:18-slim

# add curl for healthcheck + openssl for certificates
RUN apt-get update && \
    apt-get install -y --no-install-recommends curl tini openssl && \
    rm -rf /var/lib/apt/lists/*

WORKDIR /usr/local/app

RUN npm install -g nodemon

COPY package*.json ./

RUN npm ci && \
 npm cache clean --force && \
 mv /usr/local/app/node_modules /node_modules

# Copie le code
COPY . .

# Créer le dossier pour les certificats
RUN mkdir -p /app/certs

# Générer les certificats SSL auto-signés au moment du build
RUN openssl req -x509 -newkey rsa:4096 -keyout /app/certs/key.pem -out /app/certs/cert.pem \
    -days 365 -nodes -subj "/C=SN/ST=Dakar/L=Dakar/O=DevOps/OU=IT/CN=localhost" && \
    chmod 644 /app/certs/cert.pem && \
    chmod 600 /app/certs/key.pem

# Expose port HTTPS
ENV PORT 443
EXPOSE 443

ENTRYPOINT ["/usr/bin/tini", "--"]
CMD ["node", "server.js"]
